# DBus фреймворк для шаринга файлов

## Концепция

В современных ОС все привыкли к механизму sharing'a, когда каким-либо образом можно передать файл другому приложению для обработки. Один из подходов к реализации sharing'a - создание централизованного сервиса, который хранит информацию об обработчиках файлов, умеющих работать с файлами с определенными расширениями.

## Необходимо

1. Реализовать DBus сервис с именем com.system.sharing на сессионной шине с использованием языка C++, который имеет 3 метода:
- void RegisterService(name: String, supportedFormats: Array<String>)<br>
Который сохраняет в конфигурационных файлах BDus сервиса информацию о том, что существует сторонний DBus сервис, с помощью которого можно открывать файлы заданых форматов. В случае ошибки метод должен возвращять DBus ошибку с человекочитаемым сообщением.
- void OpenFile(path: String)<br>
Который открывает заданный файл одним из зарегестрированных DBus сервисов, который в данный момент запущен и находится на DBus шине. Если для данного файла имеется несколько зарегестрированных DBus сервисов - выбирается случайный DBus сервис, который на данный момент запущен и находится на DBus шине. В случае ошибки метод должен возвращать DBus ошибку с человекочитаемым сообщением.
- void OpenFileUsingService(path: String, service: String)<br>
Который открывает заданный файл заданным DBus сервисом. В случае ошибки метод должен возвращать DBus ошибку с человекочитаемым сообщением.

<b>Пример использования сервиса:</b>
gdbus call -e -d com.system.sharing -o / -m com.system.sharing.OpenFile "/home/user/Documents/video.mp4"

2. Реализовать динамическую библиотеку с использованием языка C++, которая позволяет сторонним приложениям быстро и просто регистрировать DBus сервис с заданным именем на сессионной шине с единственным методом OpenFile(path: String), который выполняет обработку файла заданным способом и в случае неудачи возвращает DBus ошибку с информативным сообщением.

Динамическая библиотека должна предоставлять класс, который при вызове метода start():
- Регистрирует в основном сервисе com.system.sharing при помощи метода RegisterService сервис-обработчик с заданным именем.
- Регистрирует на DBus шине сервис с заданным именем. В качестве имени объекта необходимо использовать '/'. В качестве имени интерфейса необходимо использовать имя сервиса.
- Запускает обработку входящих DBus сообщений.

<b>Пример использования библиотеки:</b>
'''
void process(const std::string &path){ ... };

int main() {
    const std::vector<std::string> supportedFormats = {"mp4", "mov", "mp3"};

    const auto onOpenFile = [](const std::string& path, const Request& req) {
        if (!std::filesystem::exists(path)) {
            req.sendErrorResponse("File doesn't exist");
        } else {
            process(path);
            req.sendSuccessResponse();
        }
    }

    SharingService service("com.example.mediaplayer", supportedFormats, onOpenFile);
    return service.start();
}
'''

<b>Пояснение:</b><br>
Сервис com.system.sharing при запросе на открытие файла будет по DBus вызывать метод OpenFile у сервиса-обработчика.

Из терминала это выглядело бы следующим образом:<br>
gdbus call -e -d com.example.mediaplayer -o / -m com.example.mediaplayer.OpenFile "/home/user/Documents/video.mp4"

3. Реализовать базовый пример DBus сервиса-обработчика с использованием описанной во втором пункте библиотеки.

## Обязательные требования

1. Проект должен быть написан на C++ с использованием библиотек sdbus-c++ или QtDBus
2. Проект должен быть размещен на GiHub с подробным README с инструкцией по сборке и использованию
3. В проекте должна быть осмысленная история коммитов
4. Проект должен компилироваться под Linux(например Ubuntu 20.04/22.04)
5. Проект должен компилироваться без предупреждений компилятора
6. Проект должен использовать систему сборки CMake или Meson
7. Проект должен быть отформатирован при помощи clang-format

# TODO

- build shared lib